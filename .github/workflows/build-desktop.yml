name: Build Desktop App (Windows Only)

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install pnpm
        run: npm install -g pnpm@10.4.1
        shell: bash
      
      - name: Verify pnpm installation
        run: pnpm --version
        shell: bash
      
      - name: Install root dependencies
        run: pnpm install --no-frozen-lockfile
        shell: bash
      
      - name: Install desktop dependencies
        run: cd desktop && pnpm install --no-frozen-lockfile
        shell: bash
      
      - name: Build web project
        run: pnpm run build
        shell: bash
      
      - name: Download FFmpeg
        run: |
          cd desktop
          mkdir -p resources/ffmpeg/win32
          echo "Downloading FFmpeg..."
          curl -L https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip -o ffmpeg.zip
          echo "Extracting FFmpeg..."
          unzip -j ffmpeg.zip "ffmpeg-master-latest-win64-gpl/bin/ffmpeg.exe" -d resources/ffmpeg/win32/
          echo "Cleaning up..."
          rm ffmpeg.zip
          echo "FFmpeg downloaded successfully"
          ls -la resources/ffmpeg/win32/
        shell: bash
      
      - name: Build desktop app
        run: cd desktop && pnpm run build:prod
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: List build output
        run: |
          echo "Listing desktop/release directory:"
          ls -la desktop/release/ || echo "Release directory not found"
        shell: bash
      
      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: desktop/release/*.exe
          if-no-files-found: warn
  
  release:
    name: Create GitHub Release
    needs: build-windows
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/' )
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Windows installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: ./installers
      
      - name: List downloaded files
        run: |
          echo "Downloaded files:"
          ls -la ./installers/
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./installers/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
