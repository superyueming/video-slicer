name: Build Windows (Debug)

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build-windows:
    name: Build Windows Installer (Debug)
    runs-on: windows-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true
      
      - name: Debug - Show main.ts first line
        run: |
          echo "=== Checking main.ts first line ==="
          head -n 1 desktop/src/main.ts
          echo "=== Checking for hidden characters ==="
          head -n 1 desktop/src/main.ts | od -c
        shell: bash
      
      - name: Debug - Show git commit info
        run: |
          echo "=== Current commit ==="
          git log -1 --oneline
          git show HEAD:desktop/src/main.ts | head -n 5
        shell: bash
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install pnpm
        run: npm install -g pnpm@10.4.1
        shell: bash
      
      - name: Verify pnpm installation
        run: pnpm --version
        shell: bash
      
      - name: Install root dependencies
        run: pnpm install --no-frozen-lockfile
        shell: bash
      
      - name: Install desktop dependencies
        run: cd desktop && pnpm install --no-frozen-lockfile
        shell: bash
      
      - name: Build web project
        run: pnpm run build
        shell: bash
      
      - name: Download FFmpeg
        run: |
          cd desktop
          mkdir -p resources/ffmpeg/win
          curl -L https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip -o ffmpeg.zip
          unzip -j ffmpeg.zip "ffmpeg-master-latest-win64-gpl/bin/ffmpeg.exe" -d resources/ffmpeg/win/
          unzip -j ffmpeg.zip "ffmpeg-master-latest-win64-gpl/bin/ffprobe.exe" -d resources/ffmpeg/win/
          rm ffmpeg.zip
          echo "=== FFmpeg downloaded ==="
          ls -lh resources/ffmpeg/win/
        shell: bash
      
      - name: Build desktop app
        run: cd desktop && pnpm run build:prod
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: List build output
        run: |
          echo "=== Build output ==="
          ls -lh desktop/release/
        shell: bash
      
      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer-debug
          path: desktop/release/*.exe
          if-no-files-found: error
